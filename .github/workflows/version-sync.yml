name: Version Sync

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  check_version:
    runs-on: ubuntu-24.04
    outputs:
      new_version: ${{ steps.check.outputs.new_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: 'main'
          token: ${{ secrets.PAT }}
      - name: Get latest npm version
        id: npm
        run: |
          npm_version=$(npm view @musistudio/claude-code-router version)
          echo "npm_version=${npm_version}" >> $GITHUB_OUTPUT
      - name: Get local version
        id: local
        run: |
          local_version=$(cat version.txt)
          echo "local_version=${local_version}" >> $GITHUB_OUTPUT
      - name: Compare versions
        id: check
        run: |
          if [ "${{ steps.npm.outputs.npm_version }}" != "${{ steps.local.outputs.local_version }}" ]; then
            echo "New version found: ${{ steps.npm.outputs.npm_version }}"
            echo "new_version=${{ steps.npm.outputs.npm_version }}" >> $GITHUB_OUTPUT
          fi

  update_version:
    needs: check_version
    if: needs.check_version.outputs.new_version != ''
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: 'debug'
          token: ${{ secrets.PAT }}
      - name: Update version.txt
        run: |
          echo "${{ needs.check_version.outputs.new_version }}" > version.txt
      - name: Commit and push
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add version.txt
          git commit -m "chore: update version to ${{ needs.check_version.outputs.new_version }}"
          git push